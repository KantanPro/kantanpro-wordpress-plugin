<!DOCTYPE html>
<html>
<head>
    <title>Invoice Items Debug Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Invoice Items Auto-Save Debug Test</h1>
    
    <div>
        <h2>テスト用請求書項目テーブル</h2>
        <table class="invoice-items-table">
            <tbody>
                <tr>
                    <td>
                        <input type="text" name="invoice_items[0][product_name]" value="" class="invoice-item-input product-name" placeholder="商品名を入力" />
                        <input type="hidden" name="invoice_items[0][id]" value="0" />
                    </td>
                    <td>
                        <input type="number" name="invoice_items[0][price]" value="0" class="invoice-item-input price" />
                    </td>
                    <td>
                        <input type="number" name="invoice_items[0][quantity]" value="1" class="invoice-item-input quantity" />
                    </td>
                    <td>
                        <input type="text" name="invoice_items[0][unit]" value="個" class="invoice-item-input unit" />
                    </td>
                    <td>
                        <textarea name="invoice_items[0][remarks]" class="invoice-item-input remarks" placeholder="備考"></textarea>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <input type="hidden" name="order_id" value="123" />
    </div>
    
    <script>
        // デバッグ用のグローバル変数を設定
        window.ktpDebugMode = true;
        window.ajaxurl = '/wp-admin/admin-ajax.php';
        window.ktp_ajax_nonce = 'test-nonce';
        
        // 関数定義をテスト
        window.autoSaveItem = function(itemType, itemId, fieldName, fieldValue, orderId) {
            console.log('🔍 autoSaveItem called with:', {
                itemType: itemType,
                itemId: itemId,
                fieldName: fieldName,
                fieldValue: fieldValue,
                orderId: orderId
            });
            
            // テスト用のAjax（実際にはサーバーに送信しない）
            console.log('✅ Ajax request would be sent to:', window.ajaxurl);
            console.log('📝 Ajax data would be:', {
                action: 'ktp_auto_save_item',
                item_type: itemType,
                item_id: itemId,
                field_name: fieldName,
                field_value: fieldValue,
                order_id: orderId,
                nonce: window.ktp_ajax_nonce
            });
        };
        
        window.createNewItem = function(itemType, fieldName, fieldValue, orderId, $row) {
            console.log('🆕 createNewItem called with:', {
                itemType: itemType,
                fieldName: fieldName,
                fieldValue: fieldValue,
                orderId: orderId
            });
            
            // テスト用の新規ID設定
            const newId = Math.floor(Math.random() * 1000) + 1;
            $row.find('input[name*="[id]"]').val(newId);
            console.log('✅ New ID set to:', newId);
        };
        
        // イベントハンドラーのテスト
        $(document).ready(function() {
            console.log('🚀 Debug page loaded');
            
            // product-nameフィールドのblurイベントをテスト
            $(document).on('blur', '.invoice-item-input.product-name', function() {
                const $field = $(this);
                const productName = $field.val();
                const $row = $field.closest('tr');
                const itemId = $row.find('input[name*="[id]"]').val();
                const orderId = $('input[name="order_id"]').val() || $('#order_id').val();
                
                console.log('🔥 Product name blur event triggered!', {
                    productName: productName,
                    itemId: itemId,
                    orderId: orderId,
                    hasNonce: typeof ktp_ajax_nonce !== 'undefined',
                    hasAjaxurl: typeof ajaxurl !== 'undefined'
                });
                
                // 新規行（ID=0）の場合は新規作成、既存行は更新
                if (productName.trim() !== '' && orderId) {
                    if (itemId === '0') {
                        console.log('📝 Creating new item...');
                        window.createNewItem('invoice', 'product_name', productName, orderId, $row);
                    } else if (itemId) {
                        console.log('💾 Auto-saving existing item...');
                        window.autoSaveItem('invoice', itemId, 'product_name', productName, orderId);
                    }
                } else {
                    console.log('⚠️ Auto-save skipped - missing required data');
                }
            });
            
            console.log('✅ Event handlers attached');
        });
    </script>
</body>
</html>
