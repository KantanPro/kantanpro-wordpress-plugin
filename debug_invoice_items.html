<!DOCTYPE html>
<html>
<head>
    <title>Invoice Items Debug Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Invoice Items Auto-Save Debug Test</h1>
    
    <div>
        <h2>ãƒ†ã‚¹ãƒˆç”¨è«‹æ±‚æ›¸é …ç›®ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
        <table class="invoice-items-table">
            <tbody>
                <tr>
                    <td>
                        <input type="text" name="invoice_items[0][product_name]" value="" class="invoice-item-input product-name" placeholder="å•†å“åã‚’å…¥åŠ›" />
                        <input type="hidden" name="invoice_items[0][id]" value="0" />
                    </td>
                    <td>
                        <input type="number" name="invoice_items[0][price]" value="0" class="invoice-item-input price" />
                    </td>
                    <td>
                        <input type="number" name="invoice_items[0][quantity]" value="1" class="invoice-item-input quantity" />
                    </td>
                    <td>
                        <input type="text" name="invoice_items[0][unit]" value="å€‹" class="invoice-item-input unit" />
                    </td>
                    <td>
                        <textarea name="invoice_items[0][remarks]" class="invoice-item-input remarks" placeholder="å‚™è€ƒ"></textarea>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <input type="hidden" name="order_id" value="123" />
    </div>
    
    <script>
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’è¨­å®š
        window.ktpDebugMode = true;
        window.ajaxurl = '/wp-admin/admin-ajax.php';
        window.ktp_ajax_nonce = 'test-nonce';
        
        // é–¢æ•°å®šç¾©ã‚’ãƒ†ã‚¹ãƒˆ
        window.autoSaveItem = function(itemType, itemId, fieldName, fieldValue, orderId) {
            console.log('ğŸ” autoSaveItem called with:', {
                itemType: itemType,
                itemId: itemId,
                fieldName: fieldName,
                fieldValue: fieldValue,
                orderId: orderId
            });
            
            // ãƒ†ã‚¹ãƒˆç”¨ã®Ajaxï¼ˆå®Ÿéš›ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãªã„ï¼‰
            console.log('âœ… Ajax request would be sent to:', window.ajaxurl);
            console.log('ğŸ“ Ajax data would be:', {
                action: 'ktp_auto_save_item',
                item_type: itemType,
                item_id: itemId,
                field_name: fieldName,
                field_value: fieldValue,
                order_id: orderId,
                nonce: window.ktp_ajax_nonce
            });
        };
        
        window.createNewItem = function(itemType, fieldName, fieldValue, orderId, $row) {
            console.log('ğŸ†• createNewItem called with:', {
                itemType: itemType,
                fieldName: fieldName,
                fieldValue: fieldValue,
                orderId: orderId
            });
            
            // ãƒ†ã‚¹ãƒˆç”¨ã®æ–°è¦IDè¨­å®š
            const newId = Math.floor(Math.random() * 1000) + 1;
            $row.find('input[name*="[id]"]').val(newId);
            console.log('âœ… New ID set to:', newId);
        };
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
        $(document).ready(function() {
            console.log('ğŸš€ Debug page loaded');
            
            // product-nameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®blurã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
            $(document).on('blur', '.invoice-item-input.product-name', function() {
                const $field = $(this);
                const productName = $field.val();
                const $row = $field.closest('tr');
                const itemId = $row.find('input[name*="[id]"]').val();
                const orderId = $('input[name="order_id"]').val() || $('#order_id').val();
                
                console.log('ğŸ”¥ Product name blur event triggered!', {
                    productName: productName,
                    itemId: itemId,
                    orderId: orderId,
                    hasNonce: typeof ktp_ajax_nonce !== 'undefined',
                    hasAjaxurl: typeof ajaxurl !== 'undefined'
                });
                
                // æ–°è¦è¡Œï¼ˆID=0ï¼‰ã®å ´åˆã¯æ–°è¦ä½œæˆã€æ—¢å­˜è¡Œã¯æ›´æ–°
                if (productName.trim() !== '' && orderId) {
                    if (itemId === '0') {
                        console.log('ğŸ“ Creating new item...');
                        window.createNewItem('invoice', 'product_name', productName, orderId, $row);
                    } else if (itemId) {
                        console.log('ğŸ’¾ Auto-saving existing item...');
                        window.autoSaveItem('invoice', itemId, 'product_name', productName, orderId);
                    }
                } else {
                    console.log('âš ï¸ Auto-save skipped - missing required data');
                }
            });
            
            console.log('âœ… Event handlers attached');
        });
    </script>
</body>
</html>
